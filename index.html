<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>Docker Demo for Digital Science Tech Forum</title>
  <style type="text/css">
    body {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  color: #222;
  background-color: #f7f7f7;
  font-size: 100%;
}

.slide {
  position: absolute;
  top: 0; bottom: 0;
  left: 0; right: 0;
}

.slide-content {
  width: 800px;
  height: 600px;
  overflow: hidden;
  margin: 80px auto 0 auto;
  padding: 30px;

  font-weight: 200;
  font-size: 200%;
  line-height: 1.375;
}

.controls {
  position: absolute;
  bottom: 20px;
  left: 20px;
}

.arrow {
  width: 0; height: 0;
  border: 30px solid #333;
  float: left;
  margin-right: 30px;

  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.prev {
  border-top-color: transparent;
  border-bottom-color: transparent;
  border-left-color: transparent;

  border-left-width: 0;
  border-right-width: 50px;
}

.next {
  border-top-color: transparent;
  border-bottom-color: transparent;
  border-right-color: transparent;

  border-left-width: 50px;
  border-right-width: 0;
}

.prev:hover {
  border-right-color: #888;
  cursor: pointer;
}

.next:hover {
  border-left-color: #888;
  cursor: pointer;
}

h1 {
  font-size: 300%;
  line-height: 1.2;
  text-align: center;
  margin: 170px 0 0;
}

h2 {
  font-size: 100%;
  line-height: 1.2;
  margin: 5px 0;
  text-align: center;
  font-weight: 200;
}

h3 {
  font-size: 140%;
  line-height: 1.2;
  border-bottom: 1px solid #aaa;
  margin: 0;
  padding-bottom: 15px;
}

ul {
  padding: 20px 0 0 60px;
  font-weight: 200;
  line-height: 1.375;
}

.author h1 {
  font-size: 170%;
  font-weight: 200;
  text-align: center;
  margin-bottom: 30px;
}

.author h3 {
  font-weight: 100;
  text-align: center;
  font-size: 95%;
  border: none;
}

a {
  text-decoration: none;
  color: #44a4dd;
}

a:hover {
  color: #66b5ff;
}

pre {
  font-size: 60%;
  line-height: 1.3;
}

.progress {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.progress-bar {
  width: 0%;
  height: 3px;
  background-color: #b4b4b4;

  -webkit-transition: width 0.05s ease-out;
  -moz-transition: width 0.05s ease-out;
  -o-transition: width 0.05s ease-out;
  transition: width 0.05s ease-out;
}

.hidden {
  display: none;
}

@media (max-width: 850px) {

  body {
    font-size: 70%;
  }

  .slide-content {
    width: auto;
  }

  img {
    width: 100%;
  }

  h1 {
    margin-top: 120px;
  }

  .prev, .prev:hover {
    border-right-color: rgba(135, 135, 135, 0.5);
  }

  .next, .next:hover {
    border-left-color: rgba(135, 135, 135, 0.5);
  }
}

@media (max-width: 480px) {
  body {
    font-size: 50%;
    overflow: hidden;
  }

  .slide-content {
    padding: 10px;
    margin-top: 10px;
    height: 340px;
  }

  h1 {
    margin-top: 50px;
  }

  ul {
    padding-left: 25px;
  }
}

@media print {
  * {
    -webkit-print-color-adjust: exact;
  }

  @page {
    size: letter;
  }

  .hidden {
    display: inline;
  }

  html {
    width: 100%;
    height: 100%;
    overflow: visible;
  }

  body {
    margin: 0 auto !important;
    border: 0;
    padding: 0;
    float: none !important;
    overflow: visible;
    background: none !important;
    font-size: 52%;
  }

  .progress, .controls {
    display: none;
  }

  .slide {
    position: static;
  }

  .slide-content {
    border: 1px solid #222;
    margin-top: 0;
    margin-bottom: 40px;
    height: 3.5in;
    overflow: visible;
  }

  .slide:nth-child(even) {
    /* 2 slides per page */
    page-break-before: always;
  }
}

/*
github.com style (c) Vasily Polovnyov <vast@whiteants.net>
*/

code, pre {
  border: 1px solid #ddd;
  border-radius: 3px;
  overflow: auto;
  padding: 6px 10px;
}

code {
  padding: 0 5px;
}

pre>code {
  margin: 0; padding: 0;
  border: none;
  background: transparent;
}

pre .comment,
pre .template_comment,
pre .diff .header,
pre .javadoc {
  color: #998;
  font-style: italic
}

pre .keyword,
pre .css .rule .keyword,
pre .winutils,
pre .javascript .title,
pre .nginx .title,
pre .subst,
pre .request,
pre .status {
  color: #333;
  font-weight: bold
}

pre .number,
pre .hexcolor,
pre .ruby .constant {
  color: #099;
}

pre .string,
pre .tag .value,
pre .phpdoc,
pre .tex .formula {
  color: #d14
}

pre .title,
pre .id {
  color: #900;
  font-weight: bold
}

pre .javascript .title,
pre .lisp .title,
pre .clojure .title,
pre .subst {
  font-weight: normal
}

pre .class .title,
pre .haskell .type,
pre .vhdl .literal,
pre .tex .command {
  color: #458;
  font-weight: bold
}

pre .tag,
pre .tag .title,
pre .rules .property,
pre .django .tag .keyword {
  color: #000080;
  font-weight: normal
}

pre .attribute,
pre .variable,
pre .lisp .body {
  color: #008080
}

pre .regexp {
  color: #009926
}

pre .class {
  color: #458;
  font-weight: bold
}

pre .symbol,
pre .ruby .symbol .string,
pre .lisp .keyword,
pre .tex .special,
pre .prompt {
  color: #990073
}

pre .built_in,
pre .lisp .title,
pre .clojure .built_in {
  color: #0086b3
}

pre .preprocessor,
pre .pi,
pre .doctype,
pre .shebang,
pre .cdata {
  color: #999;
  font-weight: bold
}

pre .deletion {
  background: #fdd
}

pre .addition {
  background: #dfd
}

pre .diff .change {
  background: #0086b3
}

pre .chunk {
  color: #aaa
}


  </style>
</head>
<body>
    <div class="progress">
    <div class="progress-bar"></div>
  </div>

  <div class="slide" id="slide-1">
    <section class="slide-content"><h1 id="intro-to-docker">Intro to Docker</h1>
<h2 id="-hellip-and-how-we-use-it-at-writelatex">&hellip; and how we use it at writeLaTeX</h2>
<h2 id="-nbsp-">&nbsp;</h2>
<h2 id="dr-john-lees-miller">Dr John Lees-Miller</h2>
<h2 id="-jdleesmiller-https-twitter-com-jdleesmiller-writelatex-https-twitter-com-writelatex-"><a href="https://twitter.com/@jdleesmiller">@jdleesmiller</a> <a href="https://twitter.com/@writelatex">@writelatex</a></h2>
<h2 id="digital-science-tech-forum">Digital Science Tech Forum</h2>
<h2 id="30-oct-2014">30 Oct 2014</h2>
</section>
  </div>
  <div class="slide hidden" id="slide-2">
    <section class="slide-content"><h3 id="the-plan">The Plan</h3>
<ol>
<li><p>Docker by example: run a simple web app in docker.</p>
</li>
<li><p>A look at what&#39;s happening behind the scenes.</p>
</li>
<li><p>How we use docker at writeLaTeX, also by example.</p>
</li>
</ol>
</section>
  </div>
  <div class="slide hidden" id="slide-3">
    <section class="slide-content"><h3 id="resources">Resources</h3>
<p>These slides:</p>
<p><a href="http://jdlm.info/ds-docker-demo">http://jdlm.info/ds-docker-demo</a></p>
<p>Source code for examples:</p>
<p><a href="https://github.com/jdleesmiller/ds-docker-demo">https://github.com/jdleesmiller/ds-docker-demo</a></p>
</section>
  </div>
  <div class="slide hidden" id="slide-4">
    <section class="slide-content"><h3 id="mental-model">Mental Model</h3>
<p>Here&#39;s my (oversimplified) model for using docker.</p>
<ol>
<li><p>You build a disk <strong>image</strong>.</p>
</li>
<li><p>You create a <strong>container</strong> with a (notional) copy of that image and then run your <strong>command</strong> inside it.</p>
</li>
<li><p>When the command finishes, you usually throw away the container.</p>
</li>
</ol>
</section>
  </div>
  <div class="slide hidden" id="slide-5">
    <section class="slide-content"><h3 id="example-web-app">Example Web App</h3>
<p>Hello World! in Sinatra&hellip;</p>
<pre><code>$ cd examples/web_app

$ cat hello_world.rb
require &#39;sinatra&#39;

get &#39;/&#39; do
  &quot;Hello World!&quot;
end</code></pre>
</section>
  </div>
  <div class="slide hidden" id="slide-6">
    <section class="slide-content"><h3 id="image-from-dockerfile-">Image from <code>Dockerfile</code></h3>
<p>Sort of like an ansible playbook or chef recipe.</p>
<pre><code>FROM ubuntu:14.04                          # base image

MAINTAINER overleaf &lt;team@overleaf.io&gt;     # who are you?

RUN apt-get update &amp;&amp; apt-get -y upgrade   # image setup commands
RUN apt-get install -y ruby
RUN gem install sinatra
RUN mkdir /app

ADD hello_world.rb /app/                   # copy files to image

ENV PORT 8000                              # set environment vars
ENV RACK_ENV production</code></pre>
</section>
  </div>
  <div class="slide hidden" id="slide-7">
    <section class="slide-content"><h3 id="run-docker-build-">Run <code>docker build</code></h3>
<p>To build the example web app:</p>
<pre><code>$ docker build --tag hello_world .</code></pre>
<p><code>--tag</code> is how we&#39;ll refer to the image later.</p>
<p><code>.</code> tells docker that the <code>Dockerfile</code> and <code>ADD</code>ed files are in the current directory (<code>examples/web_app</code>).</p>
</section>
  </div>
  <div class="slide hidden" id="slide-8">
    <section class="slide-content"><h3 id="run-the-web-app-in-a-container">Run the Web App in a Container</h3>
<pre><code>docker run -it --rm --publish 3000:3000 hello_world ruby /app/hello_world.rb
                                      # ^           ^ command in the container
                                      # ^ image tag</code></pre>
<p>&#39;--rm&#39; removes the container once the command has exited</p>
<p><code>--publish</code> forwards port 3000 on the host from port 3000 in the container</p>
<p><code>-it</code> means interactive tty (terminal); this just lets us use Ctrl-C to interrupt the server.</p>
</section>
  </div>
  <div class="slide hidden" id="slide-9">
    <section class="slide-content"><h3 id="deploy-the-image">Deploy the Image</h3>
<p>You can save it to a tar file:</p>
<pre><code>docker save hello_world | gzip &gt; hello_world.tar.gz</code></pre>
<p>and then import it with <code>docker import</code>.</p>
<p>Or you can run a <a href="https://github.com/docker/docker-registry">private registry</a> and push the image there.</p>
</section>
  </div>
  <div class="slide hidden" id="slide-10">
    <section class="slide-content"><h3 id="behind-the-scenes-hellip-">Behind the Scenes&hellip;</h3>
<p>Let&#39;s start with the <a href="output/web_app/build.txt">build output</a>.</p>
</section>
  </div>
  <div class="slide hidden" id="slide-11">
    <section class="slide-content"><h3 id="images-are-like-git-commits">Images are like git Commits</h3>
<p>Each command in the Dockerfile makes a new image.</p>
<pre>
Step 0 : FROM ubuntu:14.04
...
Status: Downloaded newer image for ubuntu:14.04
 ---> <b>5506de2b643b</b>

Step 1 : MAINTAINER overleaf <team@overleaf.io>
...
 ---> <b>0bf3ae3662b4</b>

Step 2 : RUN apt-get update && apt-get -y upgrade
...
 ---> <b>296a361125bd</b>
</pre>

<p>Each image is identified by a <strong>hash</strong> of its <em>content</em> and its <em>ancestor</em>, like a git commit.</p>
</section>
  </div>
  <div class="slide hidden" id="slide-12">
    <section class="slide-content"><h3 id="only-diffs-of-images-are-stored">Only &quot;Diffs&quot; of Images are Stored</h3>
<pre><code>$ docker history hello_world
IMAGE               CREATED             CREATED BY                      SIZE
203c183acb03        2 minutes ago       ... #(nop) CMD [/bin/sh ...      0 B
d1df6bf66499        2 minutes ago       ... #(nop) ENV RACK_ENV=...      0 B
24a3db493063        2 minutes ago       ... #(nop) ENV PORT=3000...      0 B
e567e577d823        2 minutes ago       ... #(nop) ADD file:4164...     52 B
5695586ee7a3        2 minutes ago       ... mkdir /app          ...      0 B
a6447b00f7df        2 minutes ago       ... gem install sinatra ...   16.7 MB
60d6e9ae2318        3 minutes ago       ... apt-get install -y r...  17.67 MB
296a361125bd        4 minutes ago       ... apt-get update &amp;&amp; ap...  33.49 MB
0bf3ae3662b4        5 minutes ago       ... #(nop) MAINTAINER ov...      0 B
5506de2b643b        5 days ago          ... #(nop) CMD [/bin/bas...      0 B
22093c35d77b        5 days ago          ... apt-get update &amp;&amp; ap...  6.558 MB
3680052c0f5c        5 days ago          ... sed -i &#39;s/^#\s*\(deb...  1.895 kB
e791be0477f2        5 days ago          ... rm -rf /var/lib/apt/...      0 B
ccb62158e970        5 days ago          ... echo &#39;#!/bin/sh&#39; &gt; /...  194.8 kB
d497ad3926c8        8 days ago          ... #(nop) ADD file:3996...  192.5 MB
511136ea3c5a        16 months ago                                        0 B</code></pre>
<p>The <code>hello_world</code> tag points to image <code>203c183acb03</code>.</p>
</section>
  </div>
  <div class="slide hidden" id="slide-13">
    <section class="slide-content"><h3 id="incremental-rebuilds-are-cheap">Incremental Rebuilds are Cheap</h3>
<p>If we change <code>examples/web_app/hello_world.rb</code> to output a different message and rebuild the container, docker reuses cached images for the preceeding steps.</p>
<pre>
$ sed -i 's/World/Docker/' hello_world.rb
$ docker images -ta
...
Step 4 : RUN gem install sinatra
 ---> <b>Using cache</b>
 ---> a6447b00f7df
Step 5 : RUN mkdir /app
 ---> <b>Using cache</b>
 ---> 5695586ee7a3
Step 6 : ADD hello_world.rb /app/
 ---> 4c535a0a4a01 <em># now things have changed</em>
...
</pre></section>
  </div>
  <div class="slide hidden" id="slide-14">
    <section class="slide-content"><h3 id="images-form-a-tree">Images form a Tree</h3>
<pre>
$ docker images -ta
└─511136ea3c5a Virtual Size: 0 B
  ├─d497ad3926c8 Virtual Size: 192.5 MB
    ...
      └─5506de2b643b Virtual Size: 199.3 MB Tags: ubuntu:14.04
        ...
          └─5695586ee7a3 Virtual Size: 267.1 MB         <em># RUN mkdir /app</em>
            ├─4c535a0a4a01 Virtual Size: 267.1 MB       <em># ADD hello_world...</em>
            │ └─e7352ee9bedd Virtual Size: 267.1 MB
            │   └─fb17a307e866 Virtual Size: 267.1 MB Tags: hello_world:latest
            └─e567e577d823 Virtual Size: 267.1 MB       <em># ADD hello_world...</em>
              └─24a3db493063 Virtual Size: 267.1 MB
                └─d1df6bf66499 Virtual Size: 267.1 MB
                  └─203c183acb03 Virtual Size: 267.1 MB <em># <-- the old hello_world</em>
</pre></section>
  </div>
  <div class="slide hidden" id="slide-15">
    <section class="slide-content"><h3 id="more-about-containers">More About Containers</h3>
<p>You can run a shell in a container to explore or use an image interactively:</p>
<pre><code>docker run -it hello_world /bin/bash</code></pre>
<p>If you make changes in the container and kill it (but don&#39;t remove it), you can restart it later, and your changes will persist.
This can be useful in development, but docker has other solutions for data persistence that are better in production; see <a href="https://docs.docker.com/userguide/dockervolumes/">data volumes</a>.</p>
</section>
  </div>
  <div class="slide hidden" id="slide-16">
    <section class="slide-content"><h3 id="web-app-example-improvements">Web App Example Improvements</h3>
<ul>
<li><p>The process runs as root inside our container, which is bad. Docker can run the process as an <a href="http://docs.docker.com/reference/run/#user">unprivileged user</a> instead (exercise).</p>
</li>
<li><p>We&#39;re using system ruby on Debian, which is far out of date. It&#39;s usually better to install with <a href="http://rvm.io/">RVM</a> (exercise) or <a href="https://registry.hub.docker.com/">find a docker image in the registry</a> with ruby installed.</p>
</li>
</ul>
</section>
  </div>
  <div class="slide hidden" id="slide-17">
    <section class="slide-content"><h3 id="latex-in-a-container">LaTeX in a Container</h3>
<p>Because creating and destroying containers is very fast, we can use them for short-lived processes, too.</p>
<p>Example (<code>examples/latex/Dockerfile</code>):</p>
<pre><code>FROM ubuntu:14.04

MAINTAINER overleaf &lt;team@overleaf.io&gt;

RUN apt-get update &amp;&amp; apt-get -y upgrade

RUN apt-get install -y texlive-latex-base

WORKDIR /tmp # by default, start commands in the container in /tmp</code></pre>
</section>
  </div>
  <div class="slide hidden" id="slide-18">
    <section class="slide-content"><h3 id="latex-in-a-container">LaTeX in a Container</h3>
<p>To build and run:</p>
<pre><code>cd examples/latex
docker build --tag texlive .
docker run -it --rm --volume `pwd`:/tmp texlive pdflatex main</code></pre>
<p><code>--volume</code> mounts the current working directory on the host as <code>/tmp</code> inside the container.</p>
<p><code>pdflatex main</code> is the command that runs inside the container, to compile a file called <code>main.tex</code>.</p>
</section>
  </div>
  <div class="slide hidden" id="slide-19">
    <section class="slide-content"><h3 id="latex-example-improvements">LaTeX Example Improvements</h3>
<ul>
<li><p>Again, we shouldn&#39;t be running the compile as root in the container, but that requires getting the permissions on the host to match up with those in the container.</p>
</li>
<li><p>We could install a lot more software. A full install of TeX Live is over 4GB, and there are many related packages.</p>
</li>
</ul>
</section>
  </div>
  <div class="slide hidden" id="slide-20">
    <section class="slide-content"><h3 id="docker-at-writelatex">Docker at writeLaTeX</h3>
<ul>
<li><p>We maintain a Dockerfile that builds an image with latex and lots of related tools.</p>
</li>
<li><p>Each compile job gets its own short-lived container.</p>
</li>
<li><p>It adds another layer of security.</p>
</li>
</ul>
</section>
  </div>
  <div class="slide hidden" id="slide-21">
    <section class="slide-content"><h1 id="fin">fin</h1>
<h2 id="-nbsp-">&nbsp;</h2>
<h2 id="dr-john-lees-miller">Dr John Lees-Miller</h2>
<h2 id="-jdleesmiller-https-twitter-com-jdleesmiller-writelatex-https-twitter-com-writelatex-"><a href="https://twitter.com/@jdleesmiller">@jdleesmiller</a> <a href="https://twitter.com/@writelatex">@writelatex</a></h2>
<h2 id="digital-science-tech-forum">Digital Science Tech Forum</h2>
<h2 id="30-oct-2014">30 Oct 2014</h2>
</section>
  </div>

  <div class="controls">
    <div class="arrow prev"></div>
    <div class="arrow next"></div>
  </div>


  <script type="text/javascript">
    /**
 * Returns the current page number of the presentation.
 */
function currentPosition() {
  return parseInt(document.querySelector('.slide:not(.hidden)').id.slice(6));
}


/**
 * Navigates forward n pages
 * If n is negative, we will navigate in reverse
 */
function navigate(n) {
  var position = currentPosition();
  var numSlides = document.getElementsByClassName('slide').length;

  /* Positions are 1-indexed, so we need to add and subtract 1 */
  var nextPosition = (position - 1 + n) % numSlides + 1;

  /* Normalize nextPosition in-case of a negative modulo result */
  nextPosition = (nextPosition - 1 + numSlides) % numSlides + 1;

  document.getElementById('slide-' + position).classList.add('hidden');
  document.getElementById('slide-' + nextPosition).classList.remove('hidden');

  updateProgress();
  updateURL();
  updateTabIndex();
}


/**
 * Updates the current URL to include a hashtag of the current page number.
 */
function updateURL() {
  window.history.replaceState({} , null, '#' + currentPosition());
}


/**
 * Sets the progress indicator.
 */
function updateProgress() {
  var progressBar = document.querySelector('.progress-bar');

  if (progressBar !== null) {
    var numSlides = document.getElementsByClassName('slide').length;
    var position = currentPosition() - 1;
    var percent = (numSlides === 1) ? 100 : 100 * position / (numSlides - 1);
    progressBar.style.width = percent.toString() + '%';
  }
}


/**
 * Removes tabindex property from all links on the current slide, sets
 * tabindex = -1 for all links on other slides. Prevents slides from appearing
 * out of control.
 */
function updateTabIndex() {
  var allLinks = document.querySelectorAll('.slide a');
  var position = currentPosition();
  var currentPageLinks = document.getElementById('slide-' + position).querySelectorAll('a');
  var i;

  for (i = 0; i < allLinks.length; i++) {
    allLinks[i].setAttribute('tabindex', -1);
  }

  for (i = 0; i < currentPageLinks.length; i++) {
    currentPageLinks[i].removeAttribute('tabindex');
  }
}

/**
 * Determines whether or not we are currently in full screen mode
 */
function isFullScreen() {
  return document.fullscreenElement ||
         document.mozFullScreenElement ||
         document.webkitFullscreenElement ||
         document.msFullscreenElement;
}

/**
 * Toggle fullScreen mode on document element.
 * Works on chrome (>= 15), firefox (>= 9), ie (>= 11), opera(>= 12.1), safari (>= 5).
 */
function toggleFullScreen() {
  /* Convenient renames */
  var docElem = document.documentElement;
  var doc = document;

  docElem.requestFullscreen =
      docElem.requestFullscreen ||
      docElem.msRequestFullscreen ||
      docElem.mozRequestFullScreen ||
      docElem.webkitRequestFullscreen.bind(docElem, Element.ALLOW_KEYBOARD_INPUT);

  doc.exitFullscreen =
      doc.exitFullscreen ||
      doc.msExitFullscreen ||
      doc.mozCancelFullScreen ||
      doc.webkitExitFullscreen;

  isFullScreen() ? doc.exitFullscreen() : docElem.requestFullscreen();
}

document.addEventListener('DOMContentLoaded', function () {
  // Update the tabindex to prevent weird slide transitioning
  updateTabIndex();

  // If the location hash specifies a page number, go to it.
  var page = window.location.hash.slice(1);
  if (page) {
    navigate(parseInt(page) - 1);
  }

  document.onkeydown = function (e) {
    var kc = e.keyCode;

    // left, down, H, J, backspace, PgUp - BACK
    // up, right, K, L, space, PgDn - FORWARD
    // enter - FULLSCREEN
    if (kc === 37 || kc === 40 || kc === 8 || kc === 72 || kc === 74 || kc === 33) {
      navigate(-1);
    } else if (kc === 38 || kc === 39 || kc === 32 || kc === 75 || kc === 76 || kc === 34) {
      navigate(1);
    } else if (kc === 13) {
      toggleFullScreen();
    }
  };

  if (document.querySelector('.next') && document.querySelector('.prev')) {
    document.querySelector('.next').onclick = function (e) {
      e.preventDefault();
      navigate(1);
    };

    document.querySelector('.prev').onclick = function (e) {
      e.preventDefault();
      navigate(-1);
    };
  }
});


  </script>
</body>
</html>
